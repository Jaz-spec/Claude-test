services:
  nextjs-dev:
    name: "Next.js Development Server"
    start: "npm run dev"
    ready: "curl -f http://localhost:3000 || exit 1"
    stop: "pkill -f 'next dev'"
    triggers:
      - postEnvironmentStart

  storybook:
    name: "Storybook Server (Optional)"
    start: "npm run storybook"
    ready: "curl -f http://localhost:6006 || exit 1"
    triggers:
      - manual

tasks:
  # Environment Setup (runs on both triggers for Gitpod Desktop)
  setup-environment:
    name: "Setup Development Environment"
    command: |
      echo "ğŸš€ Setting up your development environment (Gitpod Desktop)..."
      
      # Check if dependencies need to be installed
      if [ ! -d "node_modules" ] || [ ! -f "node_modules/.package-lock.json" ]; then
        echo "ğŸ“¦ Installing dependencies..."
        npm install
        echo "âœ… Dependencies installed"
      else
        echo "âœ… Dependencies already installed"
      fi
      
      # Setup git hooks if they exist
      if [ -f ".githooks/setup.sh" ]; then
        chmod +x .githooks/setup.sh
        ./.githooks/setup.sh
        echo "âœ… Git hooks configured"
      fi
      
      # Create env file from example if it doesn't exist
      if [ -f ".env.example" ] && [ ! -f ".env.local" ]; then
        cp .env.example .env.local
        echo "âœ… Environment file created from example"
      fi
      
      # Gitpod Desktop specific: ensure proper git configuration
      git config --global --add safe.directory /workspace
      
      echo "ğŸ‰ Environment setup complete!"
    triggers:
      - postDevcontainerStart
      - postEnvironmentStart

  # Development Commands
  fresh-install:
    name: "Fresh Install (Clean Dependencies)"
    command: |
      echo "ğŸ§¹ Cleaning node_modules and package-lock.json..."
      rm -rf node_modules package-lock.json
      echo "ğŸ“¦ Installing fresh dependencies..."
      npm install
      echo "âœ… Fresh install complete!"
    triggers:
      - manual

  build-project:
    name: "Build Next.js Project"
    command: |
      echo "ğŸ—ï¸ Building project..."
      npm run build
      echo "âœ… Build complete!"
    triggers:
      - manual

  # Testing & Quality
  run-tests:
    name: "Run Test Suite"
    command: |
      echo "ğŸ§ª Running tests..."
      npm test
    triggers:
      - manual

  run-tests-watch:
    name: "Run Tests in Watch Mode"
    command: "npm run test:watch"
    triggers:
      - manual

  lint-and-fix:
    name: "Lint and Auto-fix Code"
    command: |
      echo "ğŸ” Linting code..."
      npm run lint -- --fix
      echo "âœ… Linting complete!"
    triggers:
      - manual

  type-check:
    name: "TypeScript Type Check"
    command: |
      echo "ğŸ” Checking TypeScript types..."
      npx tsc --noEmit
      echo "âœ… Type checking complete!"
    triggers:
      - manual

  format-code:
    name: "Format All Code"
    command: |
      echo "ğŸ’„ Formatting code..."
      npm run format
      echo "âœ… Code formatting complete!"
    triggers:
      - manual

  # Git Workflow Helpers
  sync-main:
    name: "Sync with Main Branch"
    command: |
      echo "ğŸ”„ Syncing with main branch..."
      git fetch origin
      git checkout main
      git pull origin main
      echo "âœ… Synced with main branch!"
    triggers:
      - manual

  create-feature-branch:
    name: "Create Feature Branch"
    command: |
      echo "Please run: git checkout -b feature/your-feature-name"
      echo "Example: git checkout -b feature/user-authentication"
    triggers:
      - manual

  # Database & External Services (if applicable)
  setup-database:
    name: "Setup Database"
    command: |
      if [ -f "prisma/schema.prisma" ]; then
        echo "ğŸ—ƒï¸ Setting up Prisma database..."
        npx prisma generate
        npx prisma db push
        if [ -f "prisma/seed.ts" ] || [ -f "prisma/seed.js" ]; then
          npm run db:seed
          echo "âœ… Database seeded!"
        fi
        echo "âœ… Database setup complete!"
      else
        echo "â„¹ï¸ No Prisma schema found, skipping database setup"
      fi
    dependencies:
      - setup-environment
    triggers:
      - manual

  reset-database:
    name: "Reset Database"
    command: |
      if [ -f "prisma/schema.prisma" ]; then
        echo "ğŸ”„ Resetting database..."
        npx prisma db push --force-reset
        if [ -f "prisma/seed.ts" ] || [ -f "prisma/seed.js" ]; then
          npm run db:seed
        fi
        echo "âœ… Database reset complete!"
      else
        echo "â„¹ï¸ No Prisma schema found, skipping database reset"
      fi
    triggers:
      - manual

  # Team Utilities
  show-team-info:
    name: "Show Team Development Info"
    command: |
      echo "ğŸ‘¥ TEAM DEVELOPMENT ENVIRONMENT"
      echo "================================"
      echo "ğŸ“ Project: $(basename $(pwd))"
      echo "ğŸŒ¿ Current branch: $(git branch --show-current)"
      echo "ğŸ‘¤ Git user: $(git config user.name) <$(git config user.email)>"
      echo "ğŸ“¦ Node version: $(node --version)"
      echo "ğŸ“¦ NPM version: $(npm --version)"
      echo ""
      echo "ğŸš€ Available ports:"
      echo "   - 3000: Next.js dev server"
      echo "   - 3001: Storybook (if enabled)"
      echo "   - 8080: Preview server"
      echo ""
      echo "ğŸ’¡ Quick commands:"
      echo "   - npm run dev: Start development server"
      echo "   - npm run build: Build for production"
      echo "   - npm test: Run tests"
      echo "   - npm run lint: Lint code"
      echo ""
      echo "ğŸ“š Check docs/ folder for team guidelines!"
    triggers:
      - manual